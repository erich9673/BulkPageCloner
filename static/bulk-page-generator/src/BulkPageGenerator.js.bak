import React, { useState, useEffect } from 'react';
import { invoke, router, view } from '@forge/bridge';

const BulkPageCloner = () => {
  const [spaces, setSpaces] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  
  // Step management
  const [currentStep, setCurrentStep] = useState(1);
  const [selectedTemplate, setSelectedTemplate] = useState(null);
  
  // Tab selection for Step 1 - either 'url' or 'browse'
  const [selectedOption, setSelectedOption] = useState('browse');
  
  // Page browser state (Step 1)
  const [confluencePageUrl, setConfluencePageUrl] = useState('');
  const [allPages, setAllPages] = useState([]);
  const [filteredPages, setFilteredPages] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedSpaceFilter, setSelectedSpaceFilter] = useState('all');
  const [loadingPages, setLoadingPages] = useState(false);
  const [pageTitle, setPageTitle] = useState('');
  
  // Step 3 state - Location Selection
  const [selectedSpace, setSelectedSpace] = useState('');
  const [pageOrganization, setPageOrganization] = useState('create-child');
  const [selectedParentPage, setSelectedParentPage] = useState('');
  const [newParentTitle, setNewParentTitle] = useState('');
  const [spacePages, setSpacePages] = useState([]);
  const [loadingSpacePages, setLoadingSpacePages] = useState(false);
  
  // Step 2 state - Bulk Generation (New simplified approach)
  const [pageCount, setPageCount] = useState(3);
  const [pageTitles, setPageTitles] = useState(['', '', '']);
  const [showAutofillSuggestion, setShowAutofillSuggestion] = useState(false);
  const [suggestedPattern, setSuggestedPattern] = useState('');
  const [generating, setGenerating] = useState(false);
  const [generationSuccess, setGenerationSuccess] = useState(null);

  // Legacy state (for backward compatibility during transition)
  const [generationMode, setGenerationMode] = useState('numbered');
  const [numberedCount, setNumberedCount] = useState(3);
  
  // Weekly configuration
  const [weeklyStartMonth, setWeeklyStartMonth] = useState('October');
  const [weeklyStartDay, setWeeklyStartDay] = useState(16);
  const [weeklyStartYear, setWeeklyStartYear] = useState(2025);
  const [weeklyCount, setWeeklyCount] = useState(4);
  
  // Monthly configuration
  const [monthlyTargetMonth, setMonthlyTargetMonth] = useState('January');
  const [monthlyTargetYear, setMonthlyTargetYear] = useState(2025);
  const [monthlyCount, setMonthlyCount] = useState(3);
  
  // Quarterly configuration
  const [quarterlyStartMonth, setQuarterlyStartMonth] = useState('January');
  const [quarterlyStartQuarter, setQuarterlyStartQuarter] = useState('Q1');
  const [quarterlyTargetYear, setQuarterlyTargetYear] = useState(2025);
  const [quarterlyCount, setQuarterlyCount] = useState(2);

  // Load all pages and check context on component mount
  useEffect(() => {
    let mounted = true;
    const load = async () => {
      if (!mounted) return;

      // Context detection removed as it's not used
      await loadAllPages();
    };

    load();
    return () => { mounted = false; };
  }, []);

  // Load all pages from all spaces - OPTIMIZED VERSION with timeout handling
  const loadAllPages = async () => {
    setLoadingPages(true);
    setError('');
    
    try {
      console.log('üöÄ Loading pages with balanced approach...');
      
      // Use the optimized backend function with timeout handling
      const result = await invoke('getAllPagesOptimized');
      
      if (result.error) {
        // If we got an error but still have some pages, show them
        if (result.pages && result.pages.length > 0) {
          setSpaces(result.spaces || []);
          setAllPages(result.pages);
          setFilteredPages(result.pages);
          setError(`Partial load completed: ${result.error}. Showing ${result.pages.length} pages.`);
        } else {
          setError('Failed to load pages: ' + result.error);
        }
        return;
      }
      
      // Set spaces and pages from the optimized response
      setSpaces(result.spaces || []);
      setAllPages(result.pages || []);
      setFilteredPages(result.pages || []);
      
      console.log(`‚úÖ Loaded ${result.totalCount} pages from ${result.loadedSpaces} spaces`);
      
    } catch (err) {
      // Check if it's a timeout error and provide better messaging
      if (err.message && err.message.includes('timed out')) {
        setError('Loading is taking longer than expected. Please try again or contact support if this persists.');
      } else {
        setError('Failed to load pages: ' + err.message);
      }
      console.error('‚ùå loadAllPages error:', err);
    } finally {
      setLoadingPages(false);
    }
  };

  // Handle URL-based page loading
  const handleUrlLoad = async () => {
    if (!confluencePageUrl.trim()) {
      setError('Please enter a Confluence page URL');
      return;
    }
    
    setLoadingPages(true);
    setError('');
    
    try {
      const result = await invoke('loadPagesFromUrl', { url: confluencePageUrl });
      
      if (result.success) {
        // For direct URL mode, skip page browsing and go straight to template upload
        if (result.directMode && result.targetPage) {
          console.log(`üéØ Direct mode: Auto-selecting page ${result.targetPage.title}`);
          
          // Load ALL spaces for Step 2 selection, not just the template space
          const allSpacesResult = await invoke('getAllSpaces');
          if (allSpacesResult.success) {
            setSpaces(allSpacesResult.spaces);
          } else {
            setSpaces(result.spaces || []); // Fallback to template space
          }
          
          // Directly upload template and move to Step 2
          try {
            const uploadResult = await invoke('uploadTemplate', { 
              pageId: result.targetPage.id,
              name: `Template: ${result.targetPage.title}`
            });
            
            if (uploadResult.success) {
              setSelectedTemplate(uploadResult.template);
              setCurrentStep(2);
              console.log('‚úÖ Direct selection successful, moved to Step 2 (Bulk Generation)');
            } else {
              setError('Failed to upload template: ' + (uploadResult.error || 'Unknown error'));
            }
          } catch (err) {
            setError('Failed to upload template: ' + err.message);
          }
        } else {
          // Original flow for browsing pages
          setSpaces(result.spaces || []);
          setAllPages(result.pages || []);
          setFilteredPages(result.pages || []);
          console.log(`‚úÖ Loaded ${result.pages?.length || 0} pages from URL`);
        }
      } else {
        setError('Failed to load pages from URL: ' + result.error);
      }
    } catch (err) {
      setError('Failed to load pages from URL: ' + err.message);
    } finally {
      setLoadingPages(false);
    }
  };

  // Filter pages based on search and space selection (memoized for performance)
  useEffect(() => {
    const timeoutId = setTimeout(() => {
      let filtered = allPages;
      
      // Filter by space
      if (selectedSpaceFilter !== 'all') {
        filtered = filtered.filter(page => page.spaceKey === selectedSpaceFilter);
      }
      
      // Filter by search query
      if (searchQuery.trim()) {
        const query = searchQuery.toLowerCase();
        filtered = filtered.filter(page => 
          page.title.toLowerCase().includes(query) ||
          page.spaceKey.toLowerCase().includes(query) ||
          page.spaceName.toLowerCase().includes(query)
        );
      }
    
      setFilteredPages(filtered);
    }, 300); // 300ms debounce for better performance
    
    return () => clearTimeout(timeoutId);
  }, [allPages, searchQuery, selectedSpaceFilter]);

  // Handle page selection for template (Step 1)
  const handlePageSelect = async (page) => {
    setLoading(true);
    setError('');
    
    try {
      const result = await invoke('uploadTemplate', { 
        pageId: page.id,
        name: `Template: ${page.title}`
      });
      
      if (result.success) {
        // Store the template object with the ID returned from the backend
        setSelectedTemplate(result.template);
        // Progress to step 2
        setCurrentStep(2);
      } else {
        setError(result.error || 'Failed to upload template');
      }
    } catch (err) {
      setError('Failed to upload template: ' + err.message);
    } finally {
      setLoading(false);
    }
  };
  
  // Load pages for selected space (Step 2)
  const loadSpacePagesForSelection = async (spaceKey) => {
    setLoadingSpacePages(true);
    try {
      // Use optimized parent page loader for Step 3 organization
      const pagesData = await invoke('getParentPageOptions', { spaceKey });
      if (pagesData.pages) {
        setSpacePages(pagesData.pages);
      }
    } catch (err) {
      console.error('Error loading pages for space:', err);
      setSpacePages([]);
    } finally {
      setLoadingSpacePages(false);
    }
  };
  
  // Handle space selection in step 2
  useEffect(() => {
    if (currentStep === 3 && selectedSpace) {
      loadSpacePagesForSelection(selectedSpace);
    }
  }, [selectedSpace, currentStep]);
  
  // Generate pages function - calls the backend resolver
  const generatePages = async () => {
    console.log('generatePages called', {
      selectedSpace,
      pageOrganization,
      selectedParentPage,
      newParentTitle,
      selectedTemplate,
      pageTitles
    });
    
    // Validate
    if (!selectedSpace) {
      console.log('Validation failed: No space selected');
      setError('Please select a Confluence space');
      return;
    }
    
    if (!pageOrganization) {
      console.log('Validation failed: No page organization selected');
      setError('Please select a page organization option');
      return;
    }
    
    if (pageOrganization === 'create-child' && !selectedParentPage) {
      console.log('Validation failed: create-child mode but no parent page');
      setError('Please select a parent page');
      return;
    }
    
    if (pageOrganization === 'create' && !newParentTitle.trim()) {
      console.log('Validation failed: create mode but no parent title');
      setError('Please enter a title for the new parent page');
      return;
    }
    
    if (!selectedTemplate?.id) {
      setError('Please select a template page first');
      return;
    }
    
    // Validate all page titles are filled
    const nonEmptyTitles = pageTitles.filter(title => title.trim());
    if (nonEmptyTitles.length !== pageCount) {
      setError(`Please fill in all ${pageCount} page titles`);
      return;
    }
    
    // Handle duplicates by adding (1), (2), etc.
    const deduplicatedTitles = handleDuplicateNames(nonEmptyTitles);
    console.log('Original titles:', nonEmptyTitles);
    console.log('Deduplicated titles:', deduplicatedTitles);
    
    setError('');
    setGenerating(true);
    
    try {
      // Call the backend resolver
      const result = await invoke('bulkGeneratePages', {
        templateId: selectedTemplate.id,
        spaceKey: selectedSpace,
        pageTitle: deduplicatedTitles[0], // First title as base title
        pageTitles: deduplicatedTitles, // Use deduplicated titles
        generationMode: 'bulk',
        numberedCount: deduplicatedTitles.length,
        pageOrganization: pageOrganization,
        parentPageId: selectedParentPage,
        newParentTitle: newParentTitle
      });
      
      console.log('Pages generated successfully:', result);
      setGenerationSuccess(result);
      setCurrentStep(4);
      
    } catch (error) {
      console.error('Failed to generate pages:', error);
      setError('Failed to create pages: ' + error.message);
    } finally {
      setGenerating(false);
    }
  };
  
  // Handle next button in step 2 - kept for backward compatibility
  const handleNextStep = () => {
    console.log('handleNextStep called - redirecting to generatePages');
    generatePages();
  };

  // Helper function to handle duplicates by adding (1), (2), etc.
  const handleDuplicateNames = (titles) => {
    const seen = {};
    const result = [];
    
    titles.forEach(title => {
      const trimmedTitle = title.trim();
      if (!trimmedTitle) {
        result.push('');
        return;
      }
      
      if (!seen[trimmedTitle]) {
        seen[trimmedTitle] = 1;
        result.push(trimmedTitle);
      } else {
        const count = seen[trimmedTitle];
        seen[trimmedTitle] = count + 1;
        result.push(`${trimmedTitle} (${count})`);
      }
    });
    
    return result;
  };

  // Helper functions for new Step 2
  const updatePageCount = (newCount) => {
    setPageCount(newCount);
    setPageTitles(prev => {
      const newTitles = [...prev];
      // Add empty titles if increasing count
      while (newTitles.length < newCount) {
        newTitles.push('');
      }
      // Remove excess titles if decreasing count
      if (newTitles.length > newCount) {
        newTitles.splice(newCount);
      }
      return newTitles;
    });
  };

  const updatePageTitle = (index, value) => {
    const newTitles = [...pageTitles];
    newTitles[index] = value;
    setPageTitles(newTitles);
    
    // Check for patterns after user enters 2+ titles
    if (index >= 1 && value.trim() && newTitles[index-1]?.trim()) {
      detectAndSuggestPattern(newTitles, index + 1);
    }
  };

  const detectAndSuggestPattern = (titles, fromIndex) => {
    const filledTitles = titles.slice(0, fromIndex).filter(t => t.trim());
    if (filledTitles.length < 2) return;

    // Detect number pattern
    const numberPattern = detectNumberPattern(filledTitles);
    if (numberPattern) {
      setSuggestedPattern(numberPattern);
      setShowAutofillSuggestion(true);
      return;
    }

    // Detect date pattern  
    const datePattern = detectDatePattern(filledTitles);
    if (datePattern) {
      setSuggestedPattern(datePattern);
      setShowAutofillSuggestion(true);
      return;
    }
  };

  const detectNumberPattern = (titles) => {
    const numbers = titles.map(title => {
      const match = title.match(/(\d+)/);
      return match ? parseInt(match[1]) : null;
    }).filter(n => n !== null);

    if (numbers.length >= 2) {
      const diff = numbers[1] - numbers[0];
      if (diff > 0 && numbers.every((n, i) => i === 0 || n === numbers[0] + (diff * i))) {
        return `number sequence (+${diff})`;
      }
    }
    return null;
  };

  const detectDatePattern = (titles) => {
    // Enhanced date pattern detection for various formats
    const monthWithYearRegex = /(January|February|March|April|May|June|July|August|September|October|November|December)\s+(\d{4})/i;
    const monthOnlyRegex = /^(January|February|March|April|May|June|July|August|September|October|November|December)$/i;
    const monthInTitleRegex = /(January|February|March|April|May|June|July|August|September|October|November|December)/i;
    const quarterRegex = /Q([1-4])\s+(\d{4})/i;
    const standardDateRegex = /(\d{1,2}\/\d{1,2}\/\d{4}|\w+ \d{1,2}, \d{4})/;
    
    // Check for monthly patterns with year (e.g., "January 2026", "February 2026")
    const monthWithYearMatches = titles.map(title => title.match(monthWithYearRegex)).filter(Boolean);
    if (monthWithYearMatches.length >= 2) {
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      const month1 = months.indexOf(monthWithYearMatches[0][1].toLowerCase());
      const month2 = months.indexOf(monthWithYearMatches[1][1].toLowerCase());
      if (month2 === month1 + 1) return 'monthly progression with year';
    }
    
    // Check for simple monthly patterns (e.g., "March", "April")
    const monthOnlyMatches = titles.map(title => title.match(monthOnlyRegex)).filter(Boolean);
    if (monthOnlyMatches.length >= 2) {
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      const month1 = months.indexOf(monthOnlyMatches[0][1].toLowerCase());
      const month2 = months.indexOf(monthOnlyMatches[1][1].toLowerCase());
      if (month2 === month1 + 1) return 'simple monthly progression';
    }
    
    // Check for months embedded in titles (e.g., "Hello January", "Hello February")
    const monthInTitleMatches = titles.map(title => title.match(monthInTitleRegex)).filter(Boolean);
    if (monthInTitleMatches.length >= 2) {
      const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
      const month1 = months.indexOf(monthInTitleMatches[0][1].toLowerCase());
      const month2 = months.indexOf(monthInTitleMatches[1][1].toLowerCase());
      if (month2 === month1 + 1) return 'embedded monthly progression';
    }
    
    // Check for quarterly patterns (e.g., "Q1 2026", "Q2 2026" or just "Q2", "Q3")
    const quarterWithYearMatches = titles.map(title => title.match(/Q([1-4])\s+(\d{4})/i)).filter(Boolean);
    if (quarterWithYearMatches.length >= 2) {
      const q1 = parseInt(quarterWithYearMatches[0][1]);
      const q2 = parseInt(quarterWithYearMatches[1][1]);
      if (q2 === q1 + 1) return 'quarterly progression';
    }
    
    // Check for simple quarterly patterns (e.g., "Q2", "Q3")
    const quarterOnlyMatches = titles.map(title => title.match(/Q([1-4])(?!\s*\d)/i)).filter(Boolean);
    if (quarterOnlyMatches.length >= 2) {
      const q1 = parseInt(quarterOnlyMatches[0][1]);
      const q2 = parseInt(quarterOnlyMatches[1][1]);
      if (q2 === q1 + 1) return 'simple quarterly progression';
    }
    
    // Check for embedded quarterly patterns (e.g., "Report Q2", "Report Q3")
    const quarterInTitleMatches = titles.map(title => title.match(/Q([1-4])/i)).filter(Boolean);
    if (quarterInTitleMatches.length >= 2) {
      const q1 = parseInt(quarterInTitleMatches[0][1]);
      const q2 = parseInt(quarterInTitleMatches[1][1]);
      if (q2 === q1 + 1) return 'embedded quarterly progression';
    }
    
    // Check for standard date patterns with flexible formats
    const flexibleDateRegex = /(\d{1,2})\/(\d{1,2})\/(\d{2,4})/;
    
    // Try flexible date format first (handles 2-digit years)
    const flexDates = titles.map(title => {
      const dateMatch = title.match(flexibleDateRegex);
      if (dateMatch) {
        let [, month, day, year] = dateMatch;
        // Handle 2-digit years by assuming 20xx
        if (year.length === 2) {
          year = '20' + year;
        }
        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
      }
      return null;
    }).filter(d => d && !isNaN(d));

    if (flexDates.length >= 2) {
      const diffDays = (flexDates[1] - flexDates[0]) / (1000 * 60 * 60 * 24);
      if (diffDays === 7) return 'weekly dates';
      if (diffDays >= 28 && diffDays <= 31) return 'monthly dates';
      if (diffDays > 0) return 'date progression';
    }
    
    // Check standard date patterns as fallback
    const dates = titles.map(title => {
      const dateMatch = title.match(standardDateRegex);
      return dateMatch ? new Date(dateMatch[1]) : null;
    }).filter(d => d && !isNaN(d));

    if (dates.length >= 2) {
      const diffDays = (dates[1] - dates[0]) / (1000 * 60 * 60 * 24);
      if (diffDays === 7) return 'weekly dates';
      if (diffDays >= 28 && diffDays <= 31) return 'monthly dates';
    }
    return null;
  };

  const applyAutofill = () => {
    const newTitles = [...pageTitles];
    const filledCount = newTitles.findIndex(t => !t.trim());
    const baseTitles = newTitles.slice(0, filledCount);
    
    if (suggestedPattern.includes('number sequence')) {
      applyNumberPattern(newTitles, baseTitles);
    } else if (suggestedPattern.includes('progression') || suggestedPattern.includes('dates')) {
      applyDatePattern(newTitles, baseTitles);
    }
    
    setPageTitles(newTitles);
    setShowAutofillSuggestion(false);
  };

  const copyFirstTitle = () => {
    if (pageTitles[0] && pageTitles[0].trim()) {
      const newTitles = [...pageTitles];
      for (let i = 1; i < newTitles.length; i++) {
        newTitles[i] = pageTitles[0];
      }
      setPageTitles(newTitles);
    }
  };

  const applyNumberPattern = (newTitles, baseTitles) => {
    // Find the highest number in the existing titles to continue from there
    const numbersFound = [];
    baseTitles.forEach((title, index) => {
      const match = title.match(/^(.*?)(\d+)(.*)$/);
      if (match) {
        const [, prefix, num, suffix] = match;
        numbersFound.push({ 
          number: parseInt(num), 
          prefix, 
          suffix, 
          index 
        });
      }
    });

    if (numbersFound.length > 0) {
      // Use the pattern from the title with the highest number
      const latestNumberData = numbersFound.reduce((latest, current) => 
        current.number > latest.number ? current : latest
      );
      
      const { number: currentNum, prefix, suffix } = latestNumberData;
      
      // Continue the sequence from the highest number found
      for (let i = baseTitles.length; i < newTitles.length; i++) {
        const nextNum = currentNum + (i - baseTitles.length + 1);
        newTitles[i] = `${prefix}${nextNum}${suffix}`;
      }
    } else {
      // Fallback to the old logic if no numbers found
      const lastTitle = baseTitles[baseTitles.length - 1];
      const match = lastTitle.match(/^(.*?)(\d+)(.*)$/);
      if (match) {
        const [, prefix, num, suffix] = match;
        for (let i = baseTitles.length; i < newTitles.length; i++) {
          const nextNum = parseInt(num) + (i - baseTitles.length + 1);
          newTitles[i] = `${prefix}${nextNum}${suffix}`;
        }
      }
    }
  };

  const applyDatePattern = (newTitles, baseTitles) => {
    const lastTitle = baseTitles[baseTitles.length - 1];
    
    if (suggestedPattern.includes('monthly progression with year')) {
      // Handle "January 2026" -> "February 2026" patterns
      const monthRegex = /(.*?)(January|February|March|April|May|June|July|August|September|October|November|December)(.*?)(\d{4})(.*)/i;
      const match = lastTitle.match(monthRegex);
      if (match) {
        const [, prefix, monthName, middle, year, suffix] = match;
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const currentMonth = months.indexOf(monthName);
        
        for (let i = baseTitles.length; i < newTitles.length; i++) {
          const nextMonthIndex = (currentMonth + (i - baseTitles.length + 1)) % 12;
          let nextYear = parseInt(year);
          if (currentMonth + (i - baseTitles.length + 1) >= 12) {
            nextYear += Math.floor((currentMonth + (i - baseTitles.length + 1)) / 12);
          }
          newTitles[i] = `${prefix}${months[nextMonthIndex]}${middle}${nextYear}${suffix}`;
        }
      }
    } else if (suggestedPattern.includes('simple monthly progression')) {
      // Handle simple "March" -> "April" patterns
      const monthRegex = /^(January|February|March|April|May|June|July|August|September|October|November|December)$/i;
      const match = lastTitle.match(monthRegex);
      if (match) {
        const monthName = match[1];
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const currentMonth = months.indexOf(monthName);
        
        for (let i = baseTitles.length; i < newTitles.length; i++) {
          const nextMonthIndex = (currentMonth + (i - baseTitles.length + 1)) % 12;
          newTitles[i] = months[nextMonthIndex];
        }
      }
    } else if (suggestedPattern.includes('embedded monthly progression')) {
      // Handle "marketing march" -> "marketing april" patterns
      // Find the chronologically latest month in the sequence, not just the last entered title
      const monthInTitleRegex = /(.*?)(January|February|March|April|May|June|July|August|September|October|November|December)(.*)/i;
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      // Find all months in the existing titles and their positions
      const monthsFound = [];
      baseTitles.forEach((title, index) => {
        const match = title.match(monthInTitleRegex);
        if (match) {
          const [, prefix, monthName, suffix] = match;
          const monthIndex = months.indexOf(monthName);
          monthsFound.push({ monthIndex, prefix, suffix, title, index });
        }
      });
      
      if (monthsFound.length > 0) {
        // Find the chronologically latest month (highest month index)
        const latestMonth = monthsFound.reduce((latest, current) => 
          current.monthIndex > latest.monthIndex ? current : latest
        );
        
        const { monthIndex: currentMonth, prefix, suffix } = latestMonth;
        
        for (let i = baseTitles.length; i < newTitles.length; i++) {
          const nextMonthIndex = (currentMonth + (i - baseTitles.length + 1)) % 12;
          newTitles[i] = `${prefix}${months[nextMonthIndex]}${suffix}`;
        }
      }
    } else if (suggestedPattern.includes('quarterly progression')) {
      // Handle "Q1 2026" -> "Q2 2026" patterns with proper cycling
      const quarterRegex = /(.*?)Q([1-4])(.*?)(\d{4})(.*)/i;
      const match = lastTitle.match(quarterRegex);
      if (match) {
        const [, prefix, quarter, middle, year, suffix] = match;
        const currentQuarter = parseInt(quarter);
        const currentYear = parseInt(year);
        
        for (let i = baseTitles.length; i < newTitles.length; i++) {
          const totalQuarters = currentQuarter + (i - baseTitles.length + 1);
          const nextQuarter = ((totalQuarters - 1) % 4) + 1;
          const nextYear = currentYear + Math.floor((totalQuarters - 1) / 4);
          newTitles[i] = `${prefix}Q${nextQuarter}${middle}${nextYear}${suffix}`;
        }
      }
    } else if (suggestedPattern.includes('simple quarterly progression')) {
      // Handle "Q2" -> "Q3" patterns
      const quarterRegex = /(.*?)Q([1-4])(.*)/i;
      const match = lastTitle.match(quarterRegex);
      if (match) {
        const [, prefix, quarter, suffix] = match;
        const currentQuarter = parseInt(quarter);
        
        for (let i = baseTitles.length; i < newTitles.length; i++) {
          const nextQuarter = ((currentQuarter + (i - baseTitles.length + 1) - 1) % 4) + 1;
          newTitles[i] = `${prefix}Q${nextQuarter}${suffix}`;
        }
      }
    } else if (suggestedPattern.includes('embedded quarterly progression')) {
      // Handle embedded quarter patterns like "Report Q2"
      const quarterRegex = /(.*?)Q([1-4])(.*)/i;
      const match = lastTitle.match(quarterRegex);
      if (match) {
        const [, prefix, quarter, suffix] = match;
        const currentQuarter = parseInt(quarter);
        
        for (let i = baseTitles.length; i < newTitles.length; i++) {
          const nextQuarter = ((currentQuarter + (i - baseTitles.length + 1) - 1) % 4) + 1;
          newTitles[i] = `${prefix}Q${nextQuarter}${suffix}`;
        }
      }
    } else if (suggestedPattern.includes('date progression')) {
      // Handle flexible date progression like "1/28/26" -> "2/4/26"
      const flexibleDateRegex = /(.*?)(\d{1,2})\/(\d{1,2})\/(\d{2,4})(.*)/;
      const match = lastTitle.match(flexibleDateRegex);
      if (match) {
        const [, prefix, month, day, year, suffix] = match;
        let baseDate = new Date(year.length === 2 ? '20' + year : year, parseInt(month) - 1, parseInt(day));
        
        // Detect the interval by looking at the difference between first two dates
        const firstTitleMatch = baseTitles[0].match(flexibleDateRegex);
        if (firstTitleMatch) {
          const [, , fMonth, fDay, fYear] = firstTitleMatch;
          const firstDate = new Date(fYear.length === 2 ? '20' + fYear : fYear, parseInt(fMonth) - 1, parseInt(fDay));
          const diffDays = (baseDate - firstDate) / (1000 * 60 * 60 * 24);
          
          for (let i = baseTitles.length; i < newTitles.length; i++) {
            const nextDate = new Date(baseDate);
            nextDate.setDate(nextDate.getDate() + diffDays * (i - baseTitles.length + 1));
            const nextMonth = nextDate.getMonth() + 1;
            const nextDay = nextDate.getDate();
            const nextYear = nextDate.getFullYear().toString().slice(-2);
            newTitles[i] = `${prefix}${nextMonth}/${nextDay}/${nextYear}${suffix}`;
          }
        }
      }
    } else {
      // Handle standard weekly/monthly date patterns
      const lastDate = new Date();
      for (let i = baseTitles.length; i < newTitles.length; i++) {
        if (suggestedPattern.includes('weekly')) {
          lastDate.setDate(lastDate.getDate() + 7);
        } else if (suggestedPattern.includes('monthly')) {
          lastDate.setMonth(lastDate.getMonth() + 1);
        }
        newTitles[i] = `Page - ${lastDate.toLocaleDateString()}`;
      }
    }
  };

  const handleClose = async () => {
    try {
      await view.close();
    } catch (error) {
      console.error('Error closing view:', error);
    }
  };

  return (
    <div style={{ 
      padding: '20px', 
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
      width: '100%',
      maxWidth: 'none',
      boxSizing: 'border-box',
      overflowX: 'hidden',
      position: 'relative'
    }}>
      {/* X Close Button - positioned in top-right corner */}
      <button
        onClick={handleClose}
        style={{
          position: 'absolute',
          top: '10px',
          right: '10px',
          width: '32px',
          height: '32px',
          backgroundColor: 'transparent',
          border: '1px solid #DFE1E6',
          borderRadius: '50%',
          cursor: 'pointer',
          fontSize: '16px',
          fontWeight: 'bold',
          color: '#6B778C',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          transition: 'all 0.2s ease',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
        }}
        onMouseEnter={(e) => {
          e.target.style.backgroundColor = '#F4F5F7';
          e.target.style.borderColor = '#B3B9C4';
          e.target.style.color = '#000000';
        }}
        onMouseLeave={(e) => {
          e.target.style.backgroundColor = 'transparent';
          e.target.style.borderColor = '#DFE1E6';
          e.target.style.color = '#6B778C';
        }}
        title="Close"
      >
        ‚úï
      </button>
      
      {/* Messages */}
      {error && (
        <div style={{
          backgroundColor: '#FFEBE6',
          border: '1px solid #FF8F73',
          color: '#BF2600',
          padding: '12px',
          borderRadius: '3px',
          marginBottom: '20px',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
        }}>
          {error}
        </div>
      )}

      {/* Step 1: Select Page as Template */}
      {currentStep === 1 && (
        <div style={{ 
          backgroundColor: 'white', 
          padding: '20px', 
          borderRadius: '3px', 
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
          width: '100%',
          boxSizing: 'border-box',
          overflowX: 'auto'
        }}>
          <h3 style={{ 
            marginBottom: '16px', 
            color: '#000000', 
            fontWeight: 'bold',
            fontSize: '22px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' 
          }}>
            üìÑ Select a Page as Template OR Paste URL
          </h3>
        
        {/* Two Clear Options - Now Clickable Tabs */}
        <div style={{ 
          display: 'grid', 
          gridTemplateColumns: '1fr auto 1fr', 
          gap: '20px', 
          alignItems: 'center', 
          marginBottom: '24px',
          border: '2px solid #F4F5F7',
          borderRadius: '8px',
          padding: '20px'
        }}>
          {/* Option 1: Browse & Search (Now Primary) */}
          <div 
            onClick={() => setSelectedOption('browse')}
            style={{ 
              textAlign: 'center',
              cursor: 'pointer',
              padding: '12px',
              borderRadius: '6px',
              backgroundColor: selectedOption === 'browse' ? '#E3FCEF' : 'transparent',
              border: selectedOption === 'browse' ? '2px solid #00B8D9' : '2px solid transparent',
              transition: 'all 0.2s ease'
            }}
          >
            <h4 style={{ 
              margin: '0 0 12px 0', 
              color: selectedOption === 'browse' ? '#00875A' : '#0052CC', 
              fontSize: '16px', 
              fontWeight: '600',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
            }}>
              üîç Browse & Search
            </h4>
            <p style={{ 
              margin: '0', 
              color: selectedOption === 'browse' ? '#00875A' : '#6B778C', 
              fontSize: '14px',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
            }}>
              Explore available pages
            </p>
          </div>
          
          {/* OR Divider */}
          <div style={{ 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center',
            fontSize: '14px',
            fontWeight: '600',
            color: '#97A0AF',
            backgroundColor: '#F4F5F7',
            borderRadius: '20px',
            padding: '8px 16px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
          }}>
            OR
          </div>
          
          {/* Option 2: Paste URL (Now Secondary) */}
          <div 
            onClick={() => setSelectedOption('url')}
            style={{ 
              textAlign: 'center',
              cursor: 'pointer',
              padding: '12px',
              borderRadius: '6px',
              backgroundColor: selectedOption === 'url' ? '#E3FCEF' : 'transparent',
              border: selectedOption === 'url' ? '2px solid #00B8D9' : '2px solid transparent',
              transition: 'all 0.2s ease'
            }}
          >
            <h4 style={{ 
              margin: '0 0 12px 0', 
              color: selectedOption === 'url' ? '#00875A' : '#0052CC', 
              fontSize: '16px', 
              fontWeight: '600',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
            }}>
              üîó Paste URL
            </h4>
            <p style={{ 
              margin: '0', 
              color: selectedOption === 'url' ? '#00875A' : '#6B778C', 
              fontSize: '14px',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
            }}>
              Have a specific page in mind?
            </p>
          </div>
        </div>

        {/* Show Browse & Search by default (now primary option) */}
        {selectedOption === 'browse' && (
        <>
        {/* Browse & Search Section */}
        <div style={{ 
          marginBottom: '20px',
          padding: '16px',
          backgroundColor: '#F8F9FA',
          border: '1px solid #DFE1E6',
          borderRadius: '6px'
        }}>
          <label style={{ 
            display: 'block', 
            marginBottom: '8px', 
            fontWeight: '600', 
            color: '#0052CC', 
            fontSize: '15px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' 
          }}>
            üîç Search Pages
          </label>
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Search page titles, spaces, or URLs..."
            style={{
              width: '100%',
              padding: '8px 12px',
              border: '1px solid #DFE1E6',
              borderRadius: '3px',
              fontSize: '14px',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
            }}
          />
        </div>
          
        {/* Filter by Space Section */}
        <div style={{ marginBottom: '20px' }}>
          <label style={{ 
            display: 'block', 
            marginBottom: '8px', 
            fontWeight: '600', 
            color: '#42526E', 
            fontSize: '14px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' 
          }}>
            üìÅ Filter by Space
          </label>
          <select
            value={selectedSpaceFilter}
            onChange={(e) => setSelectedSpaceFilter(e.target.value)}
            style={{
              width: '100%',
              maxWidth: '350px',
              padding: '10px 12px',
              border: '1px solid #DFE1E6',
              borderRadius: '6px',
              fontSize: '14px',
              backgroundColor: 'white',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
            }}
          >
            <option value="all">All Spaces</option>
            {spaces.map((space) => (
              <option key={space.key} value={space.key}>
                {space.name} ({space.key})
              </option>
            ))}
          </select>
        </div>

        <div style={{ 
          marginBottom: '16px', 
          color: 'black',
          fontWeight: 'bold', 
          fontSize: '14px', 
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
          backgroundColor: '#FFFAE6',
          padding: '8px 12px',
          borderRadius: '4px',
          border: '1px solid #FFC400',
          display: 'inline-block'
        }}>
          üìÑ Found {filteredPages.length} pages
        </div>

        {/* Pages Table */}
        {loadingPages ? (
          <div style={{ 
            textAlign: 'center', 
            padding: '40px', 
            color: '#6B778C', 
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' 
          }}>
            <div style={{ fontSize: '16px', marginBottom: '8px' }}>üîÑ Loading pages...</div>
          </div>
        ) : (
          <table style={{ 
            border: '1px solid #DFE1E6', 
            borderRadius: '3px', 
            borderCollapse: 'collapse', 
            width: '100%',
            tableLayout: 'fixed'
          }}>
            <thead>
              <tr style={{ 
                backgroundColor: '#F4F5F7', 
                borderBottom: '1px solid #DFE1E6' 
              }}>
                <th style={{ 
                  padding: '12px', 
                  textAlign: 'left', 
                  fontWeight: '600', 
                  color: '#000000', 
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
                  width: '35%',
                  wordWrap: 'break-word'
                }}>
                  Page Title
                </th>
                <th style={{ 
                  padding: '12px', 
                  textAlign: 'left', 
                  fontWeight: '600', 
                  color: '#000000', 
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
                  width: '30%'
                }}>
                  Space
                </th>
                <th style={{ 
                  padding: '12px', 
                  textAlign: 'left', 
                  fontWeight: '600', 
                  color: '#000000', 
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
                  width: '20%'
                }}>
                  Last Modified
                </th>
                <th style={{ 
                  padding: '12px', 
                  textAlign: 'center', 
                  fontWeight: '600', 
                  color: '#000000', 
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
                  width: '15%'
                }}>
                  Action
                </th>
              </tr>
            </thead>
            <tbody>
              {filteredPages.length === 0 ? (
                <tr>
                  <td colSpan="4" style={{ 
                    padding: '20px', 
                    textAlign: 'center', 
                    color: 'black', 
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' 
                  }}>
                    {searchQuery || selectedSpaceFilter !== 'all' 
                      ? 'No pages found matching your search criteria.'
                      : 'No pages available.'
                    }
                  </td>
                </tr>
              ) : (
                filteredPages.slice(0, 50).map((page) => (
                  <tr key={page.id} style={{ borderBottom: '1px solid #F4F5F7' }}>
                    <td style={{ 
                      padding: '12px', 
                      color: 'black', 
                      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
                      wordWrap: 'break-word',
                      overflowWrap: 'break-word'
                    }}>
                      {page.title}
                    </td>
                    <td style={{ 
                      padding: '12px', 
                      color: 'black', 
                      fontSize: '14px', 
                      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
                      wordWrap: 'break-word',
                      overflowWrap: 'break-word'
                    }}>
                      {page.spaceName} ({page.spaceKey})
                    </td>
                    <td style={{ 
                      padding: '12px', 
                      color: 'black', 
                      fontSize: '14px', 
                      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
                      wordWrap: 'break-word'
                    }}>
                      {page.lastModified || 'Unknown'}
                    </td>
                    <td style={{ padding: '12px', textAlign: 'center' }}>
                      <button
                        onClick={() => handlePageSelect(page)}
                        disabled={loading}
                        style={{
                          backgroundColor: loading ? '#DFE1E6' : '#0052CC',
                          color: 'white',
                          border: 'none',
                          padding: '6px 12px',
                          borderRadius: '3px',
                          fontSize: '14px',
                          cursor: loading ? 'not-allowed' : 'pointer',
                          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                        }}
                      >
                        Select
                      </button>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        )}
        </>
        )}

        {/* Show URL input only when URL option is selected */}
        {selectedOption === 'url' && (
        <div style={{ 
          marginBottom: '24px',
          padding: '16px',
          backgroundColor: '#F8F9FA',
          border: '1px solid #DFE1E6',
          borderRadius: '6px'
        }}>
          <label style={{
            display: 'block',
            marginBottom: '8px',
            color: '#0052CC',
            fontWeight: '600',
            fontSize: '15px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
          }}>
            üîó Paste Confluence URL
          </label>
          <input
            type="text"
            value={confluencePageUrl}
            onChange={(e) => setConfluencePageUrl(e.target.value)}
            placeholder="Paste URL here to load pages from specific space..."
            style={{
              width: '100%',
              padding: '8px 12px',
              border: '1px solid #DFE1E6',
              borderRadius: '3px',
              fontSize: '14px',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
              backgroundColor: 'white',
              color: 'black',
              boxSizing: 'border-box'
            }}
          />
          {confluencePageUrl && (
            <button
              onClick={() => handleUrlLoad()}
              disabled={loadingPages}
              style={{
                marginTop: '8px',
                padding: '8px 16px',
                backgroundColor: loadingPages ? '#DFE1E6' : '#0052CC',
                color: 'white',
                border: 'none',
                borderRadius: '3px',
                fontSize: '14px',
                cursor: loadingPages ? 'not-allowed' : 'pointer',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}
            >
              {loadingPages ? 'üîÑ Loading...' : 'üîç Load from URL'}
            </button>
          )}
        </div>
        )}
        </div>
      )}
      
      {/* Step 3: Location Selection */}
      {currentStep === 3 && (
        <div style={{ 
          backgroundColor: 'white', 
          padding: '20px', 
          borderRadius: '3px', 
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
          width: '100%',
          boxSizing: 'border-box',
          overflowX: 'auto'
        }}>
          <h3 style={{ 
            marginBottom: '8px', 
            color: '#000000', 
            fontWeight: 'bold',
            fontSize: '22px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
            display: 'flex',
            alignItems: 'center',
            gap: '8px'
          }}>
            <span>ÔøΩ</span> Location
          </h3>
          
          
          {/* Select Confluence Space */}
          <div style={{
            backgroundColor: '#DEEBFF',
            padding: '20px',
            borderRadius: '3px',
            marginBottom: '20px'
          }}>
            <div style={{ marginBottom: '12px' }}>
              <label style={{ 
                display: 'block', 
                fontWeight: 'bold',
                color: '#000000',
                marginBottom: '4px',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}>
                üìÅ Select Confluence Space
              </label>
              <p style={{ 
                margin: '0 0 12px 0', 
                fontSize: '14px', 
                color: '#000000',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' 
              }}>
                Choose the Confluence space where your reports will be created.
              </p>
              <select
                value={selectedSpace}
                onChange={(e) => {
                  setSelectedSpace(e.target.value);
                  setSelectedParentPage('');
                }}
                style={{
                  width: '100%',
                  padding: '8px 12px',
                  border: '1px solid #0052CC',
                  borderRadius: '3px',
                  fontSize: '14px',
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                }}
              >
                <option value="">Select a space...</option>
                {spaces.map((space) => (
                  <option key={space.key} value={space.key}>
                    {space.name}
                  </option>
                ))}
              </select>
            </div>
          </div>
          
          {/* Page Organization */}
          {selectedSpace && (
            <div style={{
              backgroundColor: '#F4F5F7',
              padding: '20px',
              borderRadius: '3px',
              marginBottom: '20px'
            }}>
              <div style={{ marginBottom: '12px' }}>
                <label style={{ 
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  fontWeight: 'bold',
                  color: '#000000',
                  marginBottom: '8px',
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                }}>
                  <span>üìÑ</span> Page Organization
                </label>
                <p style={{ 
                  margin: '0 0 16px 0', 
                  fontSize: '14px', 
                  color: 'black',
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' 
                }}>
                  Choose how you want to organize your reports in the selected space.
                </p>
              </div>
              
              {/* Radio option 1: Create child under existing parent */}
              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'flex', alignItems: 'flex-start', gap: '8px', cursor: 'pointer' }}>
                  <input
                    type="radio"
                    name="pageOrganization"
                    value="create-child"
                    checked={pageOrganization === 'create-child'}
                    onChange={(e) => setPageOrganization(e.target.value)}
                    style={{ marginTop: '3px' }}
                  />
                  <div>
                    <div style={{ fontWeight: '600', color: '#000000', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' }}>
                      üìÅ Create child(s) page under an existing parent page
                    </div>
                    <div style={{ fontSize: '13px', color: 'black', marginTop: '4px', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' }}>
                      Select an existing page to organize your reports underneath it
                    </div>
                  </div>
                </label>
              </div>
              
              {/* Radio option 2: Create as parent page */}
              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'flex', alignItems: 'flex-start', gap: '8px', cursor: 'pointer' }}>
                  <input
                    type="radio"
                    name="pageOrganization"
                    value="create-parent"
                    checked={pageOrganization === 'create-parent'}
                    onChange={(e) => {
                      console.log('Radio changed to:', e.target.value);
                      setPageOrganization(e.target.value);
                    }}
                    style={{ marginTop: '3px' }}
                  />
                  <div>
                    <div style={{ fontWeight: '600', color: '#000000', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' }}>
                      üìÑ Create as a parent page under '{spaces.find(s => s.key === selectedSpace)?.name}'
                    </div>
                    <div style={{ fontSize: '13px', color: 'black', marginTop: '4px', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' }}>
                      Reports will be created directly in the space as top-level pages
                    </div>
                  </div>
                </label>
              </div>
              
              {/* Radio option 3: Create new parent and child */}
              <div style={{ marginBottom: '16px' }}>
                <label style={{ display: 'flex', alignItems: 'flex-start', gap: '8px', cursor: 'pointer' }}>
                  <input
                    type="radio"
                    name="pageOrganization"
                    value="create"
                    checked={pageOrganization === 'create'}
                    onChange={(e) => setPageOrganization(e.target.value)}
                    style={{ marginTop: '3px' }}
                  />
                  <div>
                    <div style={{ fontWeight: '600', color: '#000000', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' }}>
                      üìÅ Create new parent and child page
                    </div>
                    <div style={{ fontSize: '13px', color: 'black', marginTop: '4px', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' }}>
                      Create a new parent page, then generate reports as child pages under it
                    </div>
                  </div>
                </label>
              </div>
            </div>
          )}
          
          {/* Select Existing Parent Page (only for create-child mode) */}
          {selectedSpace && pageOrganization === 'create-child' && (
            <div style={{
              backgroundColor: '#FFFAE6',
              padding: '20px',
              borderRadius: '3px',
              marginBottom: '20px',
              border: '1px solid #FFC400'
            }}>
              <label style={{ 
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                fontWeight: 'bold',
                color: '#000000',
                marginBottom: '8px',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}>
                <span>üìÑ</span> Select Existing Parent Page
              </label>
              <p style={{ 
                margin: '0 0 12px 0', 
                fontSize: '13px', 
                color: '#000000',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' 
              }}>
                Choose the parent page under which your report child pages will be created. Showing top 30 pages sorted alphabetically.
              </p>
              {loadingSpacePages ? (
                <div style={{ padding: '12px', textAlign: 'center', color: '#6B778C', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' }}>
                  Loading pages...
                </div>
              ) : (
                <select
                  value={selectedParentPage}
                  onChange={(e) => setSelectedParentPage(e.target.value)}
                  style={{
                    width: '100%',
                    padding: '8px 12px',
                    border: '1px solid #FFC400',
                    borderRadius: '3px',
                    fontSize: '14px',
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                  }}
                >
                  <option value="">Select a parent page...</option>
                  {spacePages.map((page) => (
                    <option key={page.id} value={page.id}>
                      {page.title}
                    </option>
                  ))}
                </select>
              )}
            </div>
          )}
          
          {/* New Parent Page Title (only for create mode) */}
          {selectedSpace && pageOrganization === 'create' && (
            <div style={{
              backgroundColor: '#E6FCFF',
              padding: '20px',
              borderRadius: '3px',
              marginBottom: '20px',
              border: '1px solid #00B8D9'
            }}>
              <label style={{ 
                display: 'block',
                fontWeight: 'bold',
                color: '#000000',
                marginBottom: '8px',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}>
                üìÅ New Parent Page Title
              </label>
              <p style={{ 
                margin: '0 0 12px 0', 
                fontSize: '13px', 
                color: '#000000',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif' 
              }}>
                Enter the title for the new parent page that will contain your report pages.
              </p>
              <input
                type="text"
                value={newParentTitle}
                onChange={(e) => setNewParentTitle(e.target.value)}
                placeholder="e.g., Q3 2025 Reports"
                style={{
                  width: '100%',
                  padding: '8px 12px',
                  border: '1px solid #00B8D9',
                  borderRadius: '3px',
                  fontSize: '14px',
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                }}
              />
            </div>
          )}
          
          {/* Navigation Buttons */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '24px' }}>
            <button
              onClick={() => {
                setCurrentStep(3);
                setError('');
              }}
              style={{
                padding: '8px 16px',
                backgroundColor: 'transparent',
                color: '#0052CC',
                border: 'none',
                borderRadius: '3px',
                fontSize: '14px',
                cursor: 'pointer',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
                textDecoration: 'underline'
              }}
            >
              ‚Üê Select Page as Template
            </button>
            <button
              onClick={() => {
                console.log('Create Pages button clicked!');
                generatePages();
              }}
              disabled={generating || !selectedSpace || 
                !pageOrganization ||
                (pageOrganization === 'create-child' && !selectedParentPage) ||
                (pageOrganization === 'create' && !newParentTitle.trim()) ||
                !selectedTemplate?.id ||
                !pageTitles.some(title => title.trim())
              }
              style={{
                padding: '10px 20px',
                backgroundColor: (generating || !selectedSpace || 
                  !pageOrganization ||
                  (pageOrganization === 'create-child' && !selectedParentPage) ||
                  (pageOrganization === 'create' && !newParentTitle.trim()) ||
                  !selectedTemplate?.id ||
                  !pageTitles.some(title => title.trim())) 
                  ? '#DFE1E6' : '#0052CC',
                color: 'white',
                border: 'none',
                borderRadius: '3px',
                fontSize: '14px',
                fontWeight: '600',
                cursor: (generating || !selectedSpace || 
                  !pageOrganization ||
                  (pageOrganization === 'create-child' && !selectedParentPage) ||
                  (pageOrganization === 'create' && !newParentTitle.trim()) ||
                  !selectedTemplate?.id ||
                  !pageTitles.some(title => title.trim())) 
                  ? 'not-allowed' : 'pointer',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}
            >
              {generating ? 'Creating Pages...' : 'Create Pages'}
            </button>
          </div>
        </div>
      )}
      
      {/* Step 2: Bulk Generation */}
      {currentStep === 2 && (
        <div style={{ 
          backgroundColor: 'white', 
          padding: '20px', 
          borderRadius: '3px', 
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
          width: '100%',
          boxSizing: 'border-box',
          overflowX: 'auto'
        }}>
          <h3 style={{ 
            marginBottom: '8px', 
            color: '#000000', 
            fontWeight: 'bold',
            fontSize: '22px',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif',
            display: 'flex',
            alignItems: 'center',
            gap: '8px'
          }}>
            üìã Bulk Cloning
          </h3>
          

          

          
          {/* Page Count Selector */}
          <div style={{ marginBottom: '24px' }}>
            <label style={{
              display: 'block',
              marginBottom: '8px',
              fontWeight: '600',
              color: '#42526E',
              fontSize: '15px',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
            }}>
              üìä How many pages do you want to create?
            </label>
            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
              <input
                type="range"
                min="1"
                max="25"
                value={pageCount}
                onChange={(e) => updatePageCount(parseInt(e.target.value))}
                style={{
                  width: '200px',
                  height: '6px',
                  borderRadius: '3px',
                  background: '#DFE1E6',
                  outline: 'none',
                  cursor: 'pointer'
                }}
              />
              <span style={{
                minWidth: '40px',
                padding: '6px 12px',
                backgroundColor: '#0052CC',
                color: 'white',
                borderRadius: '3px',
                fontWeight: '600',
                fontSize: '14px',
                textAlign: 'center'
              }}>
                {pageCount}
              </span>
            </div>
            <p style={{
              margin: '8px 0 0 0',
              color: '#6B778C',
              fontSize: '13px',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
            }}>
              Choose between 1-25 pages
            </p>
          </div>

          {/* Page Titles */}
          <div style={{ marginBottom: '20px' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
              <label style={{
                fontWeight: '600',
                color: '#42526E',
                fontSize: '15px',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}>
                ‚úèÔ∏è Name your pages
              </label>
              <button
                onClick={copyFirstTitle}
                style={{
                  padding: '6px 12px',
                  backgroundColor: '#0052CC',
                  color: 'white',
                  border: 'none',
                  borderRadius: '3px',
                  fontSize: '12px',
                  cursor: 'pointer',
                  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                }}
                disabled={!pageTitles[0] || !pageTitles[0].trim()}
              >
                üìã Copy First Title to All
              </button>
            </div>
            
            {/* Autofill Suggestion */}
            {showAutofillSuggestion && (
              <div style={{
                backgroundColor: '#FFF0B3',
                border: '1px solid #FFAB00',
                borderRadius: '6px',
                padding: '12px',
                marginBottom: '16px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between'
              }}>
                <span style={{ color: '#974F00', fontSize: '14px' }}>
                  ü§ñ Pattern detected: <strong>{suggestedPattern}</strong>. Continue this pattern?
                </span>
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button
                    onClick={applyAutofill}
                    style={{
                      padding: '6px 12px',
                      backgroundColor: '#36B37E',
                      color: 'white',
                      border: 'none',
                      borderRadius: '3px',
                      fontSize: '12px',
                      cursor: 'pointer'
                    }}
                  >
                    ‚úì Apply
                  </button>
                  <button
                    onClick={() => setShowAutofillSuggestion(false)}
                    style={{
                      padding: '6px 12px',
                      backgroundColor: 'transparent',
                      color: '#974F00',
                      border: '1px solid #FFAB00',
                      borderRadius: '3px',
                      fontSize: '12px',
                      cursor: 'pointer'
                    }}
                  >
                    ‚úï Ignore
                  </button>
                </div>
              </div>
            )}

            {/* Dynamic Title Inputs */}
            <div style={{ display: 'grid', gap: '8px' }}>
              {pageTitles.map((title, index) => (
                <div key={index} style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <span style={{
                    minWidth: '30px',
                    color: '#6B778C',
                    fontSize: '14px',
                    fontWeight: '600'
                  }}>
                    {index + 1}.
                  </span>
                  <input
                    type="text"
                    value={title}
                    onChange={(e) => updatePageTitle(index, e.target.value)}
                    placeholder={`Page ${index + 1} title...`}
                    style={{
                      flex: '1',
                      padding: '8px 12px',
                      border: '1px solid #DFE1E6',
                      borderRadius: '3px',
                      fontSize: '14px',
                      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                    }}
                  />
                </div>
              ))}
            </div>
          </div>

          {/* Navigation */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '24px' }}>
            <button
              onClick={() => setCurrentStep(1)}
              style={{
                padding: '10px 20px',
                backgroundColor: 'transparent',
                color: '#0052CC',
                border: '1px solid #DFE1E6',
                borderRadius: '3px',
                fontSize: '14px',
                cursor: 'pointer',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}
            >
              ‚Üê Back to Template
            </button>
            
            <button
              onClick={() => {
                // Validate all titles are filled before proceeding
                const allTitlesFilled = pageTitles.filter(title => title.trim()).length === pageCount;
                if (allTitlesFilled) {
                  // Update the old state to work with existing backend
                  setNumberedCount(pageCount);
                  setCurrentStep(3);
                } else {
                  setError(`Please fill in all ${pageCount} page titles before continuing`);
                }
              }}
              disabled={pageTitles.filter(title => title.trim()).length !== pageCount}
              style={{
                padding: '10px 20px',
                backgroundColor: (pageTitles.filter(title => title.trim()).length === pageCount) ? '#0052CC' : '#DFE1E6',
                color: 'white',
                border: 'none',
                borderRadius: '3px',
                fontSize: '14px',
                cursor: (pageTitles.filter(title => title.trim()).length === pageCount) ? 'pointer' : 'not-allowed',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}
            >
              Continue to Location ‚Üí
            </button>
          </div>
        </div>
      )}

      {/* Success Page - Step 4 */}
      {currentStep === 4 && (
        <div style={{
          backgroundColor: 'white',
          padding: '20px',
          borderRadius: '3px',
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
          width: '100%',
          boxSizing: 'border-box'
        }}>
          {/* Success Header */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            marginBottom: '24px',
            padding: '16px',
            backgroundColor: '#E3FCEF',
            borderRadius: '3px',
            border: '1px solid #36B37E'
          }}>
            <span style={{ 
              fontSize: '24px',
              color: '#36B37E'
            }}>‚úÖ</span>
            <div>
              <h3 style={{
                margin: '0 0 4px 0',
                color: '#36B37E',
                fontWeight: 'bold',
                fontSize: '16px',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}>
                Success!
              </h3>
              <p style={{
                margin: 0,
                fontSize: '14px',
                color: '#006644',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}>
                {generationSuccess && generationSuccess.pages && generationSuccess.pages.length > 0 
                  ? `${generationSuccess.pages.length} pages have been created successfully`
                  : 'Your pages have been created successfully'
                }
              </p>
            </div>
          </div>
          
          {/* Created Pages List */}
          {generationSuccess && generationSuccess.pages && generationSuccess.pages.length > 0 ? (
            <div style={{
              marginBottom: '24px'
            }}>
              <h4 style={{
                margin: '0 0 12px 0',
                color: '#172B4D',
                fontSize: '14px',
                fontWeight: 'bold',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}>
                Created Pages:
              </h4>
              <div style={{
                backgroundColor: '#F4F5F7',
                borderRadius: '3px',
                padding: '16px'
              }}>
                {generationSuccess.pages.map((page, index) => (
                  <div key={index} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    padding: '8px 0',
                    borderBottom: index < generationSuccess.pages.length - 1 ? '1px solid #DFE1E6' : 'none'
                  }}>
                    <span style={{ fontSize: '16px' }}>üìÑ</span>
                    <div style={{ flex: 1 }}>
                      <strong style={{
                        color: '#172B4D',
                        fontSize: '14px',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                      }}>
                        "{page.title}"
                      </strong>
                      <span style={{
                        color: '#6B778C',
                        fontSize: '14px',
                        marginLeft: '8px',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                      }}>
                        has been created successfully! Click to{' '}
                      </span>
                      <a 
                        href="#"
                        onClick={(e) => {
                          e.preventDefault();
                          router.open(page.url);
                        }}
                        style={{
                          color: '#0052CC',
                          textDecoration: 'none',
                          fontWeight: '500',
                          fontSize: '14px',
                          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
                        }}
                        onMouseOver={(e) => e.target.style.textDecoration = 'underline'}
                        onMouseOut={(e) => e.target.style.textDecoration = 'none'}
                      >
                        Open
                      </a>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            <div style={{
              backgroundColor: '#F4F5F7',
              borderRadius: '3px',
              padding: '16px',
              marginBottom: '24px',
              textAlign: 'center'
            }}>
              <p style={{
                margin: 0,
                color: '#6B778C',
                fontSize: '14px',
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
              }}>
                Your pages have been created successfully!
              </p>
            </div>
          )}

          {/* Create Another Button */}
          <button
            onClick={() => {
              // Reset all state
              setGenerationSuccess(null);
              setCurrentStep(1);
              setSelectedTemplate(null);
              setPageTitle('');
              setSelectedSpace('');
              setSelectedParentPage('');
              setNewParentTitle('');
              setPageOrganization('create-child');
              setGenerationMode('single');
              setNumberedCount(6);
              setWeeklyStartMonth('October');
              setWeeklyStartDay(16);
              setWeeklyStartYear(2025);
              setWeeklyCount(4);
              setMonthlyTargetMonth('January');
              setMonthlyTargetYear(2025);
              setMonthlyCount(3);
              setQuarterlyStartMonth('January');
              setQuarterlyStartQuarter('Q1');
              setQuarterlyTargetYear(2025);
              setQuarterlyCount(2);
              setError('');
            }}
            style={{
              padding: '10px 20px',
              backgroundColor: '#0052CC',
              color: 'white',
              border: 'none',
              borderRadius: '3px',
              fontSize: '14px',
              fontWeight: '500',
              cursor: 'pointer',
              fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif'
            }}
          >
            Create Another Page
          </button>
        </div>
      )}
    </div>
  );
};

export default BulkPageCloner;